name: Deploy to Digital Ocean

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build and push backend image
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./back-end
          file: ./back-end/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:latest,${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:buildcache,mode=max

      # Build and push frontend image
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./front-end
          file: ./front-end/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:latest,${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:buildcache,mode=max

      # Verify secrets are present (fail fast if missing)
      - name: Verify deployment secrets
        run: |
          if [ -z "${{ secrets.DO_SSH_PRIVATE_KEY }}" ]; then 
            echo "‚ùå ERROR: DO_SSH_PRIVATE_KEY secret is missing or empty" >&2
            exit 1
          fi
          if [ -z "${{ secrets.DO_HOST }}" ]; then 
            echo "‚ùå ERROR: DO_HOST secret is missing or empty" >&2
            exit 1
          fi
          if [ -z "${{ secrets.DO_USERNAME }}" ]; then 
            echo "‚ùå ERROR: DO_USERNAME secret is missing or empty" >&2
            exit 1
          fi
          echo "‚úÖ All deployment secrets are present"
          echo "üì° Target: ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }}"

      # Set up SSH using ssh-agent (more reliable than manual key writing)
      - name: Start ssh-agent and add deployment key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      # Add Digital Ocean host to known_hosts
      - name: Add DO host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DO_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ Added ${{ secrets.DO_HOST }} to known_hosts"

      # Test SSH connectivity before deployment
      - name: Test SSH connection
        run: |
          echo "üîå Testing SSH connection to ${{ secrets.DO_HOST }}..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
            "${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }}" \
            'echo "‚úÖ SSH connection successful"; docker --version' || {
            echo "‚ùå SSH connection failed. Retrying with verbose output..."
            ssh -vvv -o ConnectTimeout=10 \
              "${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }}" \
              'echo "SSH OK"' 2>&1 | grep -i "auth\|key\|permission" || true
            exit 1
          }

      # Deploy to Digital Ocean
      - name: Deploy to Digital Ocean
        run: |
          ssh -o StrictHostKeyChecking=no \
            "${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }}" << 'ENDSSH'
            set -e
            echo "üöÄ Starting deployment on $(hostname)..."
            cd /root/4-final-random_grandeeism || { mkdir -p /root/4-final-random_grandeeism && cd /root/4-final-random_grandeeism; }
            
            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              cat > .env << 'EOF'
          DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
          NODE_ENV=production
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PORT=7001
          USE_MOCK_DB=false
          EOF
              echo "‚úÖ Created .env file"
            fi
            
            # Pull latest images
            echo "üì• Pulling latest Docker images..."
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:latest"
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:latest"
            
            # Stop and remove old containers
            echo "üõë Stopping old containers..."
            docker stop fieldnotes-backend fieldnotes-frontend 2>/dev/null || true
            docker rm fieldnotes-backend fieldnotes-frontend 2>/dev/null || true
            
            # Create network if it doesn't exist
            docker network inspect fieldnotes-network >/dev/null 2>&1 || \
              docker network create fieldnotes-network
            
            # Start backend
            echo "üîß Starting backend..."
            docker run -d \
              --name fieldnotes-backend \
              --network fieldnotes-network \
              --restart unless-stopped \
              -p 7001:7001 \
              -e NODE_ENV=production \
              -e PORT=7001 \
              -e "MONGODB_URI=${{ secrets.MONGODB_URI }}" \
              -e "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
              -e USE_MOCK_DB=false \
              "${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-backend:latest"
            
            # Start frontend
            echo "üé® Starting frontend..."
            docker run -d \
              --name fieldnotes-frontend \
              --network fieldnotes-network \
              --restart unless-stopped \
              -p 80:80 \
              "${{ secrets.DOCKERHUB_USERNAME }}/fieldnotes-frontend:latest"
            
            # Wait for services to start
            echo "‚è≥ Waiting for services to start..."
            sleep 15
            
            # Check container status
            docker ps --filter "name=fieldnotes" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Clean up old images
            echo "üßπ Cleaning up old images..."
            docker image prune -af
            
            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      # Verify deployment
      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ secrets.DO_HOST }}/health || exit 1
          echo "‚úÖ Deployment successful!"
